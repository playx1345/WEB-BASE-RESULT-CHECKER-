import React, { useState } from 'react';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { toast } from 'sonner';
import { supabase } from '@/integrations/supabase/client';
import { InputSanitizer } from '@/lib/security';
import { verifyAdminAccess } from '@/lib/roleUtils';

interface AdminCreateStudentDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onStudentCreated: () => void;
}

export function AdminCreateStudentDialog({ 
  open, 
  onOpenChange, 
  onStudentCreated 
}: AdminCreateStudentDialogProps) {
  const [formData, setFormData] = useState({
    fullName: '',
    matricNumber: '',
    level: '',
    phoneNumber: '',
    pin: '',
    useAutoGenerated: true // Default to auto-generated secure PIN
  });
  const [loading, setLoading] = useState(false);
  const [errors, setErrors] = useState<{[key: string]: string}>({});

  const validateForm = () => {
    const newErrors: {[key: string]: string} = {};
    
    const sanitizedName = InputSanitizer.sanitizeText(formData.fullName);
    const sanitizedMatric = InputSanitizer.sanitizeMatricNumber(formData.matricNumber);
    const sanitizedPhone = InputSanitizer.sanitizePhoneNumber(formData.phoneNumber);
    const sanitizedPIN = InputSanitizer.sanitizePIN(formData.pin);
    
    if (!sanitizedName || sanitizedName.length < 2) {
      newErrors.fullName = 'Full name must be at least 2 characters';
    }
    
    if (!sanitizedMatric) {
      newErrors.matricNumber = 'Matric number is required';
    } else if (!InputSanitizer.validateMatricNumber(sanitizedMatric)) {
      newErrors.matricNumber = 'Invalid format. Use: CS/2021/001';
    }
    
    if (!formData.level) {
      newErrors.level = 'Level is required';
    }
    
    if (sanitizedPhone && !InputSanitizer.validatePhoneNumber(sanitizedPhone)) {
      newErrors.phoneNumber = 'Invalid phone number format';
    }
    
    // Only validate PIN if not using auto-generated
    if (!formData.useAutoGenerated && !InputSanitizer.validatePIN(sanitizedPIN)) {
      newErrors.pin = 'PIN must be exactly 6 digits';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleInputChange = (field: string, value: string) => {
    let sanitizedValue: string | boolean = value;
    
    // Apply appropriate sanitization based on field type
    switch (field) {
      case 'fullName':
        sanitizedValue = InputSanitizer.sanitizeText(value);
        break;
      case 'matricNumber':
        sanitizedValue = InputSanitizer.sanitizeMatricNumber(value);
        break;
      case 'phoneNumber':
        sanitizedValue = InputSanitizer.sanitizePhoneNumber(value);
        break;
      case 'pin':
        sanitizedValue = InputSanitizer.sanitizePIN(value);
        break;
      case 'useAutoGenerated':
        sanitizedValue = value === 'true';
        break;
    }
    
    setFormData(prev => ({ ...prev, [field]: sanitizedValue }));
    
    // Clear error when user starts typing
    if (errors[field]) {
      setErrors(prev => ({ ...prev, [field]: '' }));
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      toast.error('Please fix the validation errors');
      return;
    }

    setLoading(true);

    try {
      // Verify admin access before proceeding
      const adminCheck = await verifyAdminAccess();
      if (!adminCheck.hasAccess) {
        toast.error(adminCheck.message);
        setLoading(false);
        return;
      }

      // Final sanitization before sending to backend
      const sanitizedData = {
        p_full_name: InputSanitizer.sanitizeText(formData.fullName),
        p_matric_number: InputSanitizer.sanitizeMatricNumber(formData.matricNumber),
        p_level: formData.level,
        p_phone_number: formData.phoneNumber ? InputSanitizer.sanitizePhoneNumber(formData.phoneNumber) : null,
        p_pin: formData.useAutoGenerated ? null : InputSanitizer.sanitizePIN(formData.pin)
      };

      const { data, error } = await supabase.rpc('admin_create_student', sanitizedData);

      if (error) {
        console.error('Error creating student:', error);
        
        // More specific error handling
        if (error.message.includes('duplicate key') || error.message.includes('already exists')) {
          setErrors({ matricNumber: 'A student with this matric number already exists' });
          toast.error('A student with this matric number already exists');
        } else if (error.message.includes('Authentication required')) {
          toast.error('Please log in as an administrator to create students');
        } else if (error.message.includes('Only administrators can create students')) {
          toast.error('Only administrators can create students. Please verify your role.');
        } else if (error.message.includes('User profile not found')) {
          toast.error('User profile not found. Please contact support.');
        } else {
          toast.error('Failed to create student: ' + error.message);
        }
        return;
      }

      // Show success message with generated PIN if applicable
      const responseData = data as { success?: boolean; generated_pin?: string; message?: string } | null;
      const successMessage = responseData?.generated_pin 
        ? `Student ${formData.fullName} created successfully! Generated PIN: ${responseData.generated_pin}`
        : responseData?.message || `Student ${formData.fullName} created successfully!`;
      
      toast.success(successMessage, { duration: 8000 });
      
      // Reset form
      setFormData({
        fullName: '',
        matricNumber: '',
        level: '',
        phoneNumber: '',
        pin: '',
        useAutoGenerated: true
      });
      setErrors({});
      
      onStudentCreated();
      onOpenChange(false);
    } catch (error) {
      console.error('Unexpected error:', error);
      toast.error('An unexpected error occurred. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const handleClose = () => {
    // Reset form when closing
    setFormData({
      fullName: '',
      matricNumber: '',
      level: '',
      phoneNumber: '',
      pin: '',
      useAutoGenerated: true
    });
    setErrors({});
    onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>Create New Student</DialogTitle>
          <DialogDescription>
            Add a new student to the system. They will be able to login with their matric number and PIN.
          </DialogDescription>
        </DialogHeader>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="fullName">Full Name *</Label>
            <Input
              id="fullName"
              value={formData.fullName}
              onChange={(e) => handleInputChange('fullName', e.target.value)}
              placeholder="Enter student's full name"
              className={errors.fullName ? 'border-destructive' : ''}
              required
            />
            {errors.fullName && (
              <p className="text-sm text-destructive">{errors.fullName}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="matricNumber">Matric Number *</Label>
            <Input
              id="matricNumber"
              value={formData.matricNumber}
              onChange={(e) => handleInputChange('matricNumber', e.target.value.toUpperCase())}
              placeholder="e.g., CS/2021/001"
              className={errors.matricNumber ? 'border-destructive' : ''}
              required
            />
            {errors.matricNumber && (
              <p className="text-sm text-destructive">{errors.matricNumber}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="level">Level *</Label>
            <Select value={formData.level} onValueChange={(value) => handleInputChange('level', value)}>
              <SelectTrigger className={errors.level ? 'border-destructive' : ''}>
                <SelectValue placeholder="Select level" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="ND1">ND1 (First Year)</SelectItem>
                <SelectItem value="ND2">ND2 (Second Year)</SelectItem>
              </SelectContent>
            </Select>
            {errors.level && (
              <p className="text-sm text-destructive">{errors.level}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="phoneNumber">Phone Number</Label>
            <Input
              id="phoneNumber"
              value={formData.phoneNumber}
              onChange={(e) => handleInputChange('phoneNumber', e.target.value)}
              placeholder="Enter phone number (optional)"
              className={errors.phoneNumber ? 'border-destructive' : ''}
            />
            {errors.phoneNumber && (
              <p className="text-sm text-destructive">{errors.phoneNumber}</p>
            )}
          </div>

          <div className="space-y-3">
            <Label>Login PIN Options</Label>
            
            <div className="flex items-center space-x-2">
              <Checkbox
                id="useAutoGenerated"
                checked={formData.useAutoGenerated}
                onCheckedChange={(checked) => 
                  handleInputChange('useAutoGenerated', checked ? 'true' : 'false')
                }
              />
              <Label htmlFor="useAutoGenerated" className="text-sm font-normal">
                Generate secure PIN automatically (Recommended)
              </Label>
            </div>

            {!formData.useAutoGenerated && (
              <div className="space-y-2">
                <Label htmlFor="pin">Custom PIN</Label>
                <Input
                  id="pin"
                  value={formData.pin}
                  onChange={(e) => handleInputChange('pin', e.target.value.replace(/\D/g, '').slice(0, 6))}
                  placeholder="6-digit PIN"
                  className={errors.pin ? 'border-destructive' : ''}
                  maxLength={6}
                />
                {errors.pin && (
                  <p className="text-sm text-destructive">{errors.pin}</p>
                )}
              </div>
            )}
            
            <p className="text-xs text-muted-foreground">
              {formData.useAutoGenerated 
                ? "A secure random 6-digit PIN will be generated and displayed after creation."
                : "Enter a custom 6-digit PIN for the student."
              }
            </p>
          </div>

          <DialogFooter>
            <Button type="button" variant="outline" onClick={handleClose}>
              Cancel
            </Button>
            <Button type="submit" disabled={loading}>
              {loading ? 'Creating...' : 'Create Student'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}